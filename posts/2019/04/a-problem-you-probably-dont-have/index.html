<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="map[name:Victor Bitca]">
<meta name="description"
    content="The problem Probably you&amp;rsquo;ve been binge-watching a series and those pesky intros always got in your way, the intro and outro song is already playing on repeat in your head, the visuals already burned onto your retina, you&amp;rsquo;re ready to do anything to not hear one more time that intro song.
Some streaming services like Netflix already have a skip intro button, but how does it work? Do you really think that people at Netflix in charge of their content specify in their contracts that content providers should also provide the intro/outro time range?" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://VictorBitca.github.io/posts/2019/04/a-problem-you-probably-dont-have/" />


<title>
    
    A problem you probably don&#39;t have :: Hello there...  â€” there...
    
</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">


<link rel="stylesheet" href="https://VictorBitca.github.io/scss/main.min.2508fd4bf06e8d1a3c3a51ae0236172f80a6abb73183f6b8836b8f5d38710a7a.css">



<link rel="apple-touch-icon" sizes="180x180" href="https://VictorBitca.github.io/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://VictorBitca.github.io/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://VictorBitca.github.io/favicon-16x16.png">
<link rel="manifest" href="https://VictorBitca.github.io/site.webmanifest">
<link rel="mask-icon" href="https://VictorBitca.github.io/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="https://VictorBitca.github.io/favicon.ico">
<meta name="theme-color" content="#252627">
<meta itemprop="name" content="A problem you probably don&#39;t have">
<meta itemprop="description" content="The problem Probably you&rsquo;ve been binge-watching a series and those pesky intros always got in your way, the intro and outro song is already playing on repeat in your head, the visuals already burned onto your retina, you&rsquo;re ready to do anything to not hear one more time that intro song.
Some streaming services like Netflix already have a skip intro button, but how does it work? Do you really think that people at Netflix in charge of their content specify in their contracts that content providers should also provide the intro/outro time range?">


<meta itemprop="datePublished" content="2019-04-19T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-04-19T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="770">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://VictorBitca.github.io"/>

<meta name="twitter:title" content="A problem you probably don&#39;t have"/>
<meta name="twitter:description" content="The problem Probably you&rsquo;ve been binge-watching a series and those pesky intros always got in your way, the intro and outro song is already playing on repeat in your head, the visuals already burned onto your retina, you&rsquo;re ready to do anything to not hear one more time that intro song.
Some streaming services like Netflix already have a skip intro button, but how does it work? Do you really think that people at Netflix in charge of their content specify in their contracts that content providers should also provide the intro/outro time range?"/>




<meta property="article:published_time" content="2019-04-19 00:00:00 &#43;0000 UTC" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://VictorBitca.github.io/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">$ cd </span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://VictorBitca.github.io/about/">About</a></li><li><a href="https://VictorBitca.github.io/posts/">Posts</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>4 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title"><a href="https://VictorBitca.github.io/posts/2019/04/a-problem-you-probably-dont-have/">A problem you probably don&rsquo;t have</a></h1>

            

            <div class="post-content">
                

<h2 id="the-problem">The problem</h2>

<p>Probably you&rsquo;ve been binge-watching a series and those pesky intros always got in your way, the intro and outro song is already playing on repeat in your head, the visuals already burned onto your retina, you&rsquo;re ready to do anything to not hear one more time that intro song.</p>

<p>Some streaming services like Netflix already have a skip intro button, but how does it work?
Do you really think that people at Netflix in charge of their content specify in their contracts that content providers should also provide the intro/outro time range?
Don&rsquo;t be silly, that would be too easy.</p>

<p>This time we&rsquo;ll try to automate that, mostly because at first glance it seemed like a challenge when some series have intros that are prefixed by a variable length pre-intro scene, so every episode has a unique intro song time range.
I&rsquo;ll use <code>golang</code> mostly because I&rsquo;m not very familiar with it.
I&rsquo;ll also need to install <a href="https://ffmpeg.org/" target="_blank"><code>ffmpeg</code></a> to do some work on the video files themselves and <code>golang</code> <a href="https://github.com/go-fingerprint/" target="_blank">wrappers</a> for <a href="https://acoustid.org/chromaprint" target="_blank">chromaprint</a></p>

<h2 id="before-i-can-start">Before I can start</h2>

<p>Let&rsquo;s imagine I have have some episodes, yeah, I&rsquo;m totally a legit owner of all those imaginary episodes.
First, I need to strip the audio from the video files, using <code>ffmpeg</code> is fast and in my case, it looks like this</p>

<p>Strip the audio stream: <code>ffmpeg -i input.mkv -vn -c:a copy output.m4a</code></p>

<p>Next, I&rsquo;ll need to uncompress it into a .wav file also drop as many bytes as possible, making it mono and trimming it to first 3 minutes where usually the intro song plays should be good enough.</p>

<p>Convert to .wav: <code>ffmpeg -i output.m4a output.wav</code></p>

<p>Convert stereo .wav to mono .wav: <code>ffmpeg -I output.wav -ac 1 m_output.wav</code></p>

<p>Trim down to 180 seconds: <code>ffmpeg -i m_output.wav -af atrim=0:180 m_t_output.wav</code></p>

<p>Yes, it can be automated with a bash script, but I needed to do for like ten files&hellip; I should&rsquo;ve written a script.</p>

<h2 id="the-actual-work">The actual work</h2>

<p>By running a piece of raw audio data (a .wav file with no header) through chromaprint you get the fingerprints of those files which are actually just spectrograms, <a href="https://oxygene.sk/2011/01/how-does-chromaprint-work/" target="_blank">more info on how it works</a>.</p>


    <figure class="left" >
        <img src="https://VictorBitca.github.io/images/ep2wav.jpg"   />

        
            <figcaption class="center" >Typical output for a 3min .wav file</figcaption>
        
    </figure>



<p>Comparing two perfectly aligned audio files where the video editor was spot on with the intro song timing results in this image. The black area at the beginning is where the spectrograms match perfectly, thus, the common areas are highlighted clearly.</p>


    <figure class="left" >
        <img src="https://VictorBitca.github.io/images/2min-diff.jpg"   />

        
            <figcaption class="center" >Comparing first 2min of two episodes</figcaption>
        
    </figure>



<p>But in some cases, most of the cases actually intros aren&rsquo;t aligned perfectly, before the song intro begins there could be scenes from previous episodes or some pre-intro scenes from the current episode, those scenes always vary in lenght and if I were to compare the spectograms it would look like a bunch of noise.</p>

<p>The only way to find the common areas on two different spectrograms is to slide them past each other like a puzzle each iteration resulting in a match score.
I start with an 50% offset between the slices (<a href="https://blog.golang.org/go-slices-usage-and-internals" target="_blank">golang view of an array</a>) and end on -50% offset, good enough for the intro I&rsquo;m searching, each time the offset decreases the slices get actually a bit bigger then again smaller (highlighted in blue), after all the slide and compare action I&rsquo;ll pick the iteration with the best score and do a comparison, usually resulting in something like the picture above.</p>

<p>The initial state looks something like this.

    <figure class="left" >
        <img src="https://VictorBitca.github.io/images/match-search.jpg"   />

        
            <figcaption class="center" >Incremental sliding and comparing two fingerprints</figcaption>
        
    </figure>

</p>

<p>By the way, raw fingerprints of those two files are just <code>int32</code> slices, images above are just for visual aid and the <code>int32</code> values are one-pixel width vertical slices from each fingerprint.
The comparison between the values is done using <a href="https://en.wikipedia.org/wiki/Hamming_distance" target="_blank">Hamming distance</a> for each pair of <code>int32</code> values.</p>

<p>Once I compared the best match I get a similar result but with more numbers:</p>

<p><code>[15, 20, 9, 13, 12, 10, 6, 7, 3, 2, 2, 1, 0, 3, 2, 1, 9, 13, 12, 14]</code></p>

<p>Each value is the Hamming distance between two <code>int32</code> pairs and its easy to spot somewhere in the middle there is a subsequence that gets below 10 and sits there for quite a while.
That is the matching area I was looking for, If I were to compare those fingerprints and output an image it would have a blacker area somewhere in the middle, next step is to calculate how long it is, then taking into account the offset it is trivial to calculate where the intro song started and ended for both files.</p>


    <figure class="left" >
        <img src="https://VictorBitca.github.io/images/matcher_demo.gif"   />

        
            <figcaption class="center" >Searching for intro in 10 files (single threaded)</figcaption>
        
    </figure>



<p>The implementation can be seen <a href="https://github.com/VictorBitca/matcher" target="_blank"><code>here</code></a>.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>770 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-04-19 03:00 &#43;0300</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h"></span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    

                    
                        <span class="button next">
                            <a href="https://VictorBitca.github.io/posts/2019/04/creating-an-op-z-plugin/">
                                <span class="button__text">Creating an OP-Z Plugin</span>
                                <span class="button__icon">â†’</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2019</span>
            
                <span><a href="https://VictorBitca.github.io">Victor Bitca</a></span>
            
            <span><a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></span>
            <span> <a href="https://VictorBitca.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>
</footer>

            
        </div>

        





<script type="text/javascript" src="https://VictorBitca.github.io/js/bundle.min.cf7871ed49474a80ed457154d24e61f7881adbe0f9384951a74ac46b688a39a4dbfa68bc6d37baeb058186de354ead3487d4ee7f083ea4cba860c48600b694f3.js" integrity="sha512-z3hx7UlHSoDtRXFU0k5h94ga2&#43;D5OElRp0rEa2iKOaTb&#43;mi8bTe66wWBht41Tq00h9Tufwg&#43;pMuoYMSGALaU8w=="></script>



    </body>
</html>
